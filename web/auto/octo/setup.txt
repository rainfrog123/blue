# Octobrowser Reverse Engineering Setup

## Installed Tools
- mitmdump (mitmproxy 8.1.1) - HTTP/HTTPS traffic interception
- tshark (Wireshark 4.2.2) - Network packet capture and analysis

## Quick Reference

### mitmdump - Intercept HTTP/HTTPS Traffic
```bash
# Basic proxy on port 8080
mitmdump -p 8080

# Save traffic to file
mitmdump -p 8080 -w traffic.flow

# Read saved traffic
mitmdump -r traffic.flow

# Filter specific domains
mitmdump -p 8080 --set flow_detail=3 "~d octobrowser"

# Dump request/response bodies
mitmdump -p 8080 --flow-detail 3

# Use custom script for analysis
mitmdump -p 8080 -s analysis_script.py
```

### tshark - Capture Network Traffic
```bash
# List interfaces
tshark -D

# Capture on interface (e.g., eth0)
tshark -i eth0

# Filter by host
tshark -i any -f "host octobrowser.net"

# Filter HTTP traffic
tshark -i any -f "port 80 or port 443"

# Save to pcap file
tshark -i any -w capture.pcap

# Read pcap file
tshark -r capture.pcap

# Display HTTP requests
tshark -r capture.pcap -Y "http.request" -T fields -e http.host -e http.request.uri
```

### Configure Octobrowser to Use Proxy
1. Set HTTP/HTTPS proxy to 127.0.0.1:8080
2. Install mitmproxy CA cert for HTTPS interception:
   - Run: mitmdump once, then find cert at ~/.mitmproxy/mitmproxy-ca-cert.pem
   - Import the cert into Octobrowser's certificate store

---

## HID Fingerprinting Analysis Tools

### Installed Tools
- **strace** - Trace system calls (see what devices/files browser accesses)
- **ltrace** - Trace library calls
- **frida** - Dynamic instrumentation, hook JS/browser internals
- **radare2 (r2)** - Binary disassembly and analysis
- **lsof** - List open files/devices
- **inotifywait** - Monitor file/device access in real-time
- **lsusb** - List USB devices

### Trace System Calls (What HID devices does Octobrowser access?)
```bash
# Trace all file/device opens
strace -f -e openat,read,ioctl -o octo_trace.log <octobrowser_binary>

# Filter for /dev/ and /sys/ (hardware info)
strace -f -e openat <octobrowser_binary> 2>&1 | grep -E '/dev/|/sys/'

# Watch HID devices specifically
strace -f -e openat <octobrowser_binary> 2>&1 | grep -iE 'hid|input|usb'
```

### Monitor Device Access in Real-Time
```bash
# Watch /dev/input for HID access
inotifywait -m /dev/input/ -e access,open

# Watch /sys/class for hardware enumeration
inotifywait -m -r /sys/class/input/ -e access
```

### List Open Files/Devices
```bash
# See what files Octobrowser has open
lsof -c octobrowser | grep -E '/dev|/sys'

# List USB HID devices
lsusb -v 2>/dev/null | grep -A5 "Human Interface"
```

### Frida - Hook Browser Internals
```bash
# List running processes
frida-ps

# Trace specific function calls
frida-trace -i "open*" -i "ioctl" <pid_or_name>

# Inject custom JS to hook navigator APIs
frida -p <pid> -l hook_fingerprint.js
```

### Example Frida Script (hook_fingerprint.js)
```javascript
// Hook navigator properties used for fingerprinting
Interceptor.attach(Module.findExportByName(null, "JS_GetProperty"), {
    onEnter: function(args) {
        // Log property access
    }
});
```

### Key Locations to Monitor
- /dev/input/* - HID input devices
- /dev/hidraw* - Raw HID devices
- /sys/class/input/ - Input device info
- /sys/class/hidraw/ - HID device info
- /proc/bus/input/devices - List of input devices
- /sys/devices/ - Hardware topology

### Browser Fingerprinting APIs to Watch
- navigator.keyboard (Keyboard API)
- navigator.hid (WebHID API)
- navigator.usb (WebUSB API)
- Gamepad API
- Pointer/Touch events timing

## Notes

---

## OctoBrowser Traffic Analysis Findings

### Discovered Endpoints (via proxychains + mitmproxy)

| Domain | IPs | Purpose |
|--------|-----|---------|
| `app.octobrowser.net` | 172.67.74.219, 104.26.14.164 (Cloudflare) | Main API |
| `app01.octobrowser.net` | 18.158.190.31, 3.70.121.239 (AWS Frankfurt) | Secondary API |
| `app.obiwankenode.com` | 18.158.190.31, 3.70.121.239 (AWS Frankfurt) | Hidden/Internal API |
| `localhost:58888` | - | Local backend (uvicorn Python server) |

### Backend Server IPs (License/Auth servers)
- 130.0.233.214
- 185.237.204.161
- 192.144.56.109
- 49.12.202.225 (Hetzner)
- 135.181.107.7 (Hetzner)
- 157.90.173.69 (Hetzner)
- 38.180.67.118
- 130.193.54.41
- 3.121.32.81 (AWS)

### Local API Details
- Port: 58888
- Server: uvicorn (Python)
- Start endpoint: `/new/app/start?v={version}&client_uuid={uuid}`
- React-based web UI served from `/new/app/`

### SSL/TLS Analysis
- **SSL Library**: NSS (libnss3.so) - Mozilla Network Security Services
- **Certificate Pinning**: Yes - blocks mitmproxy interception
- **QtWebEngine**: Chrome 134.0.0.0 based (BoringSSL internally)

### Interception Methods Tried

1. **proxychains4** - Works for routing traffic, but TLS fails due to cert pinning
2. **LD_PRELOAD** - Doesn't work with AppImage format
3. **Frida SSL bypass** - Hooks install but NSS cert verification still blocks
4. **Environment variables** - SSL_CERT_FILE, REQUESTS_CA_BUNDLE don't affect NSS

### Tools Created

- `frida_ssl_bypass.js` - OpenSSL hooks (doesn't work for NSS)
- `frida_ssl_bypass_v2.js` - Dynamic library watching
- `frida_ssl_bypass_v3.js` - Fixed Frida JS runtime issues
- `frida_nss_bypass.js` - NSS-specific hooks
- `ssl_bypass.c` / `ssl_bypass.so` - LD_PRELOAD library (not compatible with AppImage)
- `launch_with_frida.sh` - Launcher script

### Working Interception Commands

```bash
# Start mitmproxy
mitmdump -p 8080 --ssl-insecure -w /tmp/octo_traffic.flow

# Start OctoBrowser with proxychains (captures connection attempts, not decrypted content)
su - vncuser -c 'DISPLAY=:1 proxychains4 -f /etc/proxychains4.conf /home/vncuser/Downloads/OctoBrowser.AppImage --no-sandbox'

# Read captured traffic
mitmdump -r /tmp/octo_traffic.flow --flow-detail 3
```

### SSL Bypass Attempts and Results

#### 1. Frida Runtime Hooking
**Result**: PARTIALLY WORKS but causes crashes
- Frida can attach and hook NSS functions
- OctoBrowser crashes with segfault after Frida instrumentation
- Error: `segfault in memfd:frida-agent-64.so`
- Likely due to anti-debugging protection in OctoBrowser

**Frida Script Created**: `frida_nss_bypass_fixed.js`
- Hooks: CERT_VerifyCertificate, CERT_VerifyCertificateNow, CERT_VerifyCert, CERT_VerifyCertName
- Successfully hooks at these offsets in libnss3.so:
  - CERT_VerifyCertificate: 0x2e960
  - CERT_VerifyCertificateNow: 0x2ef60
  - CERT_VerifyCert: 0x2d360
  - CERT_VerifyCertName: 0x70e80

#### 2. Binary Patching (libnss3.so, libssl.so.3, libcrypto.so.3)
**Result**: Libraries patched but not loadable via LD_LIBRARY_PATH
- Created `patch_nss.py` to patch NSS cert verification functions
- Patched functions to return 0 (SECSuccess) immediately
- LD_LIBRARY_PATH doesn't work with PyInstaller AppImage
- AppImage extracts to /tmp/_MEI* and uses internal libs

**Patch Script Created**: `patch_nss.py`
```bash
# Usage
python3 patch_nss.py libnss3.so libnss3.so.patched
```

**Patched Bytes**:
- libnss3.so: `31 c0 c3` (xor eax, eax; ret) after endbr64
- libssl.so.3: Same pattern for SSL_get_verify_result
- libcrypto.so.3: `b8 01 00 00 00 c3` (mov eax, 1; ret) for X509_verify_cert

#### 3. LD_PRELOAD with Frida Gadget
**Result**: AppImage doesn't work with LD_PRELOAD
- Frida Gadget downloaded to /tmp/frida-gadget.so
- AppImage's FUSE filesystem blocks LD_PRELOAD

#### 4. Proxychains
**Result**: Traffic routed but TLS handshakes fail
- proxychains4 successfully routes connections through mitmproxy
- OctoBrowser's NSS library rejects mitmproxy's certificate
- Certificate pinning prevents interception

#### 5. Transparent Proxy (iptables)
**Result**: Traffic routed but TLS still fails
- iptables can redirect traffic to mitmproxy
- Same certificate pinning issue

### Working Solution: Extract and Repack

To fully intercept HTTPS traffic, you need to:

1. **Extract PyInstaller bundle**:
```bash
cd /tmp
python3 /tmp/pyinstxtractor.py /home/vncuser/Downloads/OctoBrowser.AppImage
```

2. **Patch SSL libraries in extraction**:
```bash
cd /tmp/OctoBrowser.AppImage_extracted
python3 /allah/blue/web/auto/octo/patch_nss.py libnss3.so libnss3.so
python3 -c "
import shutil
shutil.copy('libssl.so.3', 'libssl.so.3.bak')
with open('libssl.so.3', 'r+b') as f:
    f.seek(0x34844)
    f.write(b'\\x31\\xc0\\xc3')  # xor eax, eax; ret
"
```

3. **Repack with PyInstaller or create launcher script**

### Alternative: Monitor Without Decryption

If you only need connection metadata (not content):
```bash
# Use tshark to capture TLS handshakes and see SNI
tshark -i any -Y 'tls.handshake.extensions_server_name' -T fields -e ip.dst -e tls.handshake.extensions_server_name
```

### Files Created

| File | Purpose |
|------|---------|
| `frida_nss_bypass_fixed.js` | Frida script to hook NSS cert verification |
| `frida_ssl_bypass.js` | Generic SSL bypass (OpenSSL) |
| `patch_nss.py` | Python script to patch libnss3.so |
| `ssl_bypass.c` | LD_PRELOAD library (doesn't work with AppImage) |
| `launch_with_frida.sh` | Launcher script for Frida |
| `/tmp/patched_ssl/` | Directory with patched SSL libraries |

### Known Anti-Debugging

OctoBrowser appears to detect Frida instrumentation and crashes:
- Segfault occurs in `frida-agent-64.so` 
- May use integrity checks on NSS functions
- Consider using more stealthy approaches (binary patching before execution)
