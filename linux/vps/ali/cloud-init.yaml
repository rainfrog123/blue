#cloud-config

# === SYSTEM ===
hostname: blue
preserve_hostname: true
package_update: true
package_upgrade: true

# === PACKAGES ===
packages:
  # Base tools
  - docker.io
  - docker-compose
  - git
  - tmux
  - htop
  - curl
  - wget
  - vim
  - nano
  - socat
  - net-tools
  - x11-apps
  # Build tools
  - build-essential
  - gcc
  - g++
  - make
  - python3-dev
  - python3-pip
  - python3-venv
  # KDE Plasma Desktop
  - kubuntu-desktop
  - sddm
  # VNC Server
  - tigervnc-standalone-server
  - tigervnc-common
  - dbus-x11

# === SSH CONFIG ===
ssh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC5yrqQ9Eq4di8Aalzv0OZLU8LBPXwm2CjSDl3e4LDFQK16M5baWxZb4cd5YytRJBcal28nWiZiYKcJjW7sNUuU5gmij9fBWgvX2r4Rhm7vvt8K5a1gJkcfermkJnfnImBrWHiMfOigpcfFvblYlEcXgvrIKfMeZMJ3PxRfkHEXST2PfS/nqJKZEYB6Du32Nr3LsXisJ4WLJ2la8q7Zj0kM3QW9AeBNgFLKgsez4Y8KWrlQotbgUBkxZm7vUq0aRvFBtIN24DzCjWEm9jMn6UE4d1Bad/fwqdji8cjDcINb9TN8h0oNqG2skP7jOC8tHDMhlRiP90ZtrTBamfp6lldmMQgIAY+CWxRru4Dbbtjn9ikwlcWlyRJN1PwnAbmbYzGaE/rQ7ohwNiH1b7f+znIPayFkm56yYodFjKush6/S16v5P9bgNNIrWMQ08FLYms8PeLxCXz6ZGH6bET6mvkN8Tg4GA7DlzdbaBnCBRxbaIAmA89svFk7fa/tJT8KEBsU= jeffrey

disable_root: false
ssh_pwauth: false

# === USERS ===
users:
  - default
  - name: vncuser
    groups: users
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false

# === FILES ===
write_files:
  # Shadowsocks-R config
  - path: /etc/shadowsocks-r/config.json
    permissions: '0644'
    content: |
      {
          "server":"0.0.0.0",
          "server_ipv6":"::",
          "server_port":19000,
          "local_address":"127.0.0.1",
          "local_port":1080,
          "password":"bxsnucrgk6hfish",
          "timeout":120,
          "method":"chacha20-ietf",
          "protocol":"auth_aes128_sha1",
          "protocol_param":"",
          "obfs":"plain",
          "obfs_param":"",
          "redirect":"",
          "dns_ipv6":false,
          "fast_open":true,
          "workers":5
      }

  # SSH config override
  - path: /etc/ssh/sshd_config.d/99-custom.conf
    permissions: '0644'
    content: |
      PermitRootLogin yes
      PasswordAuthentication no

  # BBR settings
  - path: /etc/sysctl.d/99-bbr.conf
    permissions: '0644'
    content: |
      net.core.default_qdisc = fq
      net.ipv4.tcp_congestion_control = bbr

  # VNC systemd service
  - path: /etc/systemd/system/vncserver@.service
    permissions: '0644'
    content: |
      [Unit]
      Description=TigerVNC server for %i
      After=syslog.target network.target

      [Service]
      Type=forking
      User=vncuser
      Group=vncuser
      WorkingDirectory=/home/vncuser
      PIDFile=/home/vncuser/.vnc/%H:%i.pid
      ExecStartPre=-/usr/bin/vncserver -kill :%i > /dev/null 2>&1
      ExecStart=/usr/bin/vncserver :%i -localhost no -geometry 1920x1080 -depth 24
      ExecStop=/usr/bin/vncserver -kill :%i

      [Install]
      WantedBy=multi-user.target

  # VNC xstartup for KDE (with dbus-launch fix)
  - path: /home/vncuser/.vnc/xstartup
    permissions: '0755'
    owner: vncuser:vncuser
    defer: true
    content: |
      #!/bin/bash
      export XDG_RUNTIME_DIR=/tmp/runtime-vncuser
      mkdir -p $XDG_RUNTIME_DIR
      chmod 700 $XDG_RUNTIME_DIR
      unset SESSION_MANAGER
      unset DBUS_SESSION_BUS_ADDRESS
      exec /usr/bin/dbus-launch --exit-with-session /usr/bin/startplasma-x11

  # VNC config
  - path: /home/vncuser/.vnc/config
    permissions: '0644'
    owner: vncuser:vncuser
    defer: true
    content: |
      geometry=1920x1080
      depth=24

  # KDE kwinrc - disable compositor for VNC
  - path: /home/vncuser/.config/kwinrc
    permissions: '0644'
    owner: vncuser:vncuser
    defer: true
    content: |
      [Compositing]
      Enabled=false
      Backend=XRender
      GLCore=false
      OpenGLIsUnsafe=true

# === COMMANDS ===
runcmd:
  # Enable BBR
  - modprobe tcp_bbr
  - sysctl --system

  # SSH config
  - sed -i 's/^#*PermitRootLogin .*/PermitRootLogin yes/' /etc/ssh/sshd_config
  - sed -i 's/^#*PasswordAuthentication .*/PasswordAuthentication no/' /etc/ssh/sshd_config
  - systemctl restart ssh

  # Clean up authorized_keys restriction
  - sed -i '/command="echo .Please login as the user/d' /root/.ssh/authorized_keys

  # Git config
  - git config --global user.name "$(openssl rand -hex 12)"
  - git config --global user.email "$(openssl rand -hex 12)@example.com"

  # Clone repo
  - mkdir -p /allah
  - cd /allah && git clone https://github.com/rainfrog123/blue.git

  # Link bashrc
  - rm -f /root/.bashrc
  - ln -sf /allah/blue/linux/extra/shell/bashrc /root/.bashrc

  # Docker setup
  - systemctl enable docker
  - systemctl start docker

  # Pull and run Shadowsocks-R
  - docker pull teddysun/shadowsocks-r
  - docker run -d -p 19000:19000 -p 19000:19000/udp --name ssr --restart=always -v /etc/shadowsocks-r:/etc/shadowsocks-r teddysun/shadowsocks-r

  # Install Clash Nyanpasu (alpha)
  - wget -O /tmp/clash-nyanpasu.deb "https://github.com/libnyanpasu/clash-nyanpasu/releases/download/pre-release/Clash.Nyanpasu_2.0.0-alpha%2B1269a20_amd64.deb"
  - dpkg -i /tmp/clash-nyanpasu.deb || apt-get install -f -y
  - rm -f /tmp/clash-nyanpasu.deb

  # Setup VNC for vncuser
  - mkdir -p /home/vncuser/.vnc
  - mkdir -p /home/vncuser/.config
  - chown -R vncuser:vncuser /home/vncuser/.vnc
  - chown -R vncuser:vncuser /home/vncuser/.config
  - chmod 700 /home/vncuser/.vnc
  # Set VNC password (abc123)
  - su - vncuser -c "printf 'abc123\nabc123\nn\n' | vncpasswd"
  - chmod 600 /home/vncuser/.vnc/passwd
  - chown vncuser:vncuser /home/vncuser/.vnc/passwd

  # Enable and start VNC
  - systemctl daemon-reload
  - systemctl enable vncserver@1
  - systemctl start vncserver@1

  # Final message
  - 'echo "Cloud-init setup complete!"'
  - 'echo "SSR: port 19000, password: bxsnucrgk6hfish"'
  - 'echo "VNC: port 5901, password: abc123"'

# === REBOOT ===
power_state:
  mode: reboot
  message: "Cloud-init complete. Rebooting..."
  timeout: 30
  condition: true
